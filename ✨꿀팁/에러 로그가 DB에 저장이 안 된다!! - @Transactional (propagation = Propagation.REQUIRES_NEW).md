
사내 프로젝트를 진행하면서, 비즈니스 로그를 남기는 기능을 구현했다.
그러나 로그가 데이터베이스에 저장되지 않는 문제가 발생했다.
이 문제를 해결하기 위해 찾아보며 공부한 내용들을 기록해두려고 한다.

### ❗️ 문제점

>[!warning]
> 로깅을 담당하는 AOP 클래스에 예외처리를 다 해두었는데도, 호출한 메서드에서 에러가 발생할 때 로그가 찍히지 않았다.

### 📌 시도

트랜잭션에 대한 의심이 먼저 들어서 `@Transactional` 어노테이션에 대해서 찾아보기 시작했다.

일단 트랜잭션 default 설정을 알아보자.

#### **기본 트랜잭션 설정**

• 전파 수준 (Propagation): REQUIRED
• 격리 수준 (Isolation): DEFAULT
• 읽기 전용 (Read-only): false
• 타임아웃 (Timeout): -1 (제한 없음)
• 롤백 규칙 (Rollback Rules): RuntimeException 및 그 하위 클래스에서만 롤백

이 기본 설정들을 하나씩 살펴보자!  

1. **전파 수준 (Propagation) - REQUIRED**:

	• 기본 설정은 REQUIRED. 즉, 현재 트랜잭션이 존재하면 해당 트랜잭션을 사용하고, 존재하지 않으면 새로운 트랜잭션을 시작한다.

2. **격리 수준 (Isolation) - DEFAULT**:

	• 기본 격리 수준은 데이터베이스의 기본 설정을 따른다. 대부분의 데이터베이스에서 READ_COMMITTED 수준이 기본으로 설정된다.

3. **읽기 전용 (Read-only) - false**:

	• 기본 설정은 읽기/쓰기가 모두 가능한 상태. readOnly 속성을 true로 설정하면, 트랜잭션이 읽기 전용 모드로 실행된다.

4. **타임아웃 (Timeout) - -1**:

	• 기본 타임아웃 값은 -1로 설정. 이는 타임아웃 제한이 없음을 의미한다. 필요에 따라 타임아웃 값을 초 단위로 설정할 수 있다.

5. **롤백 규칙 (Rollback Rules) - RuntimeException**:

	• 기본적으로 RuntimeException 및 그 하위 클래스가 발생할 경우 트랜잭션을 롤백한다. CheckedException에 대해서는 트랜잭션을 롤백하지 않는다.

여기서 원인을 알 수 있다.

1. **전파 수준 (Propagation) - REQUIRED**:

	• 로그를 기록하는 메서드에 `@Transactional`만 사용하면 기본 전파 수준인 REQUIRED가 적용된다.

	• 따라서, 호출한 메서드와 동일한 트랜잭션을 사용하게 된다.

2. **트랜잭션 롤백**:
	• 호출한 메서드에서 예외가 발생하면, 그 트랜잭션이 롤백된다.
	• 이때, 동일한 트랜잭션을 사용하는 로깅 메서드의 데이터베이스 작업도 롤백된다.
	• 따라서, 로그가 데이터베이스에 남지 않는다.
	
  

### **💡 해결 방법**

👉 **REQUIRES_NEW 적용**

감사 로그가 작업의 성공 여부와 관계없이 반드시 기록되어야 했기 때문에, REQUIRES_NEW 전파 방식을 적용하기로 했다.  

로깅이 항상 데이터베이스에 남도록 하기 위해서는 로깅 메서드에

`@Transactional(propagation = Propagation.REQUIRES_NEW)`

를 사용하여 별도의 트랜잭션으로 처리되도록 해야 한다.

이렇게 하면, 호출한 메서드의 트랜잭션과는 독립적으로 동작하여 호출한 메서드가 롤백되더라도 로깅 트랜잭션은 커밋된다.

### 📌  추가 기록

옵션을 찾다보니 `NESTED`라는 옵션도 있었는데 비교해서 기록해두려고 한다.

#### **REQUIRES_NEW와 NESTED 비교**

  
• **REQUIRES_NEW**:

• 현재 트랜잭션이 있으면 일시 중지하고, 새로운 트랜잭션을 시작한다.
• 내부 트랜잭션이 완료되면 외부 트랜잭션이 재개된다.
• 내부 트랜잭션의 성공 또는 실패는 외부 트랜잭션에 영향을 미치지 않는다.=
• 감사 로그와 같이 반드시 기록되어야 하는 경우에 적합하다.

  
• **NESTED**:
• 현재 트랜잭션의 자식 트랜잭션으로 시작한다.
• 자식 트랜잭션이 실패하면 부모 트랜잭션의 롤백 포인트로 돌아간다.
• 부모 트랜잭션이 커밋되기 전까지 자식 트랜잭션도 커밋되지 않는다.
• 부분적으로 롤백이 필요할 때 유용하다.